import os
import time
import marko

antal = 0

def writeHtmlFile(filename,content=""):
	index = 1 + filename.rindex("\\")
	md_name = filename[index:].replace('.html','.md')
	global antal
	res = []

	res.append('<!-- Generated by makeAll.py 1.0 -->')
	res.append('<html>')
	res.append('<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />')
	res.append('<head>')
	# res.append('<title>Seniorschack Stockholm</title>')
	res.append('	<link rel="STYLESHEET" type="text/css" href="blixt.css">')
	res.append('	<meta charset = "utf-8"/>')
	res.append("	<style> body  {font-family:monospace; font-size:18px } </style>")
	res.append("	<style> a {text-decoration: none } </style>")
	res.append('</head>')
	res.append('<body>')
	res += [content]
	res.append('</body>')
	res.append('<footer style=" text-align: right">')
	res.append(f'	<p><a href="{md_name}">Markdown</a></p>')
	res.append("</footer>")
	res.append('</html>')

	print(filename,md_name)
	antal += 1
	with open(filename, 'w', encoding='utf8') as g:
		g.write('\n'.join(res))

def title(s): return f"<h1>{s.replace('.md','')}</h1>"

def noExt(s):
	s = s.replace(".pdf", "")
	s = s.replace(".md", "")
	s = s.replace("_", " ")
	return s

def transpileDir(directory):

	if type(directory) is str:
		path = directory
		name = directory
	else:
		path = directory.path
		name = directory.name

	if name == 'filer': return

	name = name.replace("_", " ")
	res = []

	indexHtml = ""

	for f in os.scandir(path):
		if os.path.isfile(f):
			if f.name.endswith('.html'):
				pass
			elif f.name.endswith('index.md'):
				indexHtml = transpileFile(f.path)
			elif f.name.endswith('.md'):
				filename = f.path.replace('.md', '.html')
				writeHtmlFile(filename, title(f.name) + transpileFile(f.path))
				res += [f"<a href='{f.name.replace('.md', '.html')}'>{f.name.replace('.md', '')}</a><br><br>" + "\n"]
			else:
				res += [f"<a href='{f.name}'>{noExt(f.name)}</a><br><br>" + "\n"]
		else:
			if f.name != 'filer':
				res += [f"<a href='{f.name}\\index.html'>{f.name}</a><br><br>" + "\n"]
				transpileDir(f)

	if indexHtml == "":
		indexHtml = "\n".join(res)
	else:
		indexHtml = indexHtml.replace("CONTENT","\n".join(res))

	writeHtmlFile(path + '\\index.html', f"<h1>{name}</h1>" + indexHtml)

def transpileFile(filename):
	with open(filename,encoding='utf8') as f:
		html = marko.convert(f.read())
		html = html.replace('<red>',  '<div style=color:#F00>').replace('</red>','</div>')
		html = html.replace('<green>','<div style=color:#0A0>').replace('</green>','</div>')
		return html

start = time.time_ns()

transpileDir("Seniorschack_Stockholm")

print(antal, 'filer tog', round((time.time_ns() - start)/10**6),'ms')
