import os
import time

TOUR  = "https://member.schack.se/ShowTournamentServlet?id="
ANMÄL = "https://member.schack.se/turnering/"
BB2   = "https://storage.googleapis.com/bildbanken2/index.html?query="
SENIOR  = "https://www.seniorschack.se/"
SMALL = "https://storage.googleapis.com/bildbanken2/small/"

def countTabs (s) :
	n = 0
	for c in s:
		if c != "\t": break
		n += 1
	return n

def a(arr, prefix="", suffix=""):
	if len(arr) == 3: # COMMAND | text | link
		text = arr[1]
		link = arr[2]
		return "<a href='{link}'>{text}</a>".format(text=text, link=prefix + link + suffix)
	elif len(arr) == 4: # COMMAND | prompt | text | link
		prompt = arr[1]
		text = arr[2]
		link = arr[3]
		return "{prompt}<a href='{link}'>{text}</a>".format(prompt=prompt, text=text, link=prefix + link + suffix)
	else:
		print('Error message')

def link(arr): return a(arr)
def tour(arr): return a(arr, TOUR)
def anmäl(arr): return a(arr, ANMÄL, '/anmalan')
def bb2(arr): return a(arr, BB2)
def senior(arr): return 
def bold(arr): return "<b>"+arr[1]+"</b>"
def br(arr): return "<br>"
def h2(arr): return "<h2>"+arr[1]+"</h2>"
def small(arr): return a(arr, SMALL)
def dot(arr): return "<br>" # " • "

hash = {
	"LINK": lambda arr: a(arr),
	"TOUR": lambda arr: a(arr, TOUR),
	"ANMÄL":lambda arr: a(arr, ANMÄL, '/anmalan'),
	"BB2":lambda arr: a(arr, BB2),
	"SENIOR":lambda arr: a(arr, SENIOR),
	"A":lambda arr: a(arr),
	"SMALL":lambda arr: a(arr, SMALL),
	"H1":lambda arr: "<h1>"+arr[1]+"</h1>",
	"H2":lambda arr: "<h2>"+arr[1]+"</h2>",
	"H3":lambda arr: "<h3>"+arr[1]+"</h3>",
	"BOLD":lambda arr: "<b>"+arr[1]+"</b>",
	"DOT": lambda arr:  " • ",
	"": lambda arr: "<br>"}

def writeHtmlFile(filename,content):
	res = []

	res.append('<!-- Generated by makeAll.py 1.0 -->')
	res.append('<html>')
	res.append('<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />')
	res.append('<head>')
	res.append('	<link rel="STYLESHEET" type="text/css" href="blixt.css">')
	res.append('	<meta charset = "utf-8"/>')
	res.append("	<style> body  {font-family:monospace; font-size:18px } </style>")
	res.append('</head>')
	res.append('<body>')
	res += content
	res.append('</body>')
	res.append('</html>')

	print(filename)
	with open(filename, 'w', encoding='utf8') as g:
		g.write('\n'.join(res))

def transpileDir(directory):
	if type(directory) is str:
		path = directory
		name = directory
	else:
		path = directory.path
		name = directory.name

	files = []
	dirs = []
	res = []

	for f in os.scandir(path):
		if os.path.isfile(f):
			files.append(f)
		else:
			dirs.append(f)
			transpileDir(f)

	name = name.replace("_", " ")
	res = res + [f"<h1>{name}</h1>"]
	for f in files:
		if f.name.endswith('.html'):
			pass
		elif f.name.endswith('index.lean'):
			res = res + [transpileFile(f.path)]
		elif f.name.endswith('.lean'):
			filename = f.path.replace('.lean','.html')
			writeHtmlFile(filename,[transpileFile(f.path)])
			res = res + [f"<a href='{f.name.replace('.lean','.html')}'>{f.name.replace('.lean','')}</a><br><br>" + "\n"]
		else:
			res = res + [f"<a href='{f.name}'>{f.name.replace('.lean','')}</a><br><br>" + "\n"]

	for d in dirs:
		res = res + [f"<a href='{d.name}/index.html'>{d.name}</a><br><br>" + "\n"]

	writeHtmlFile(path + '/index.html', res)

def transpileFile(filename):
	with open(filename,encoding='utf8') as f:
		s = f.read()

	res = []

	for line in s.split("\n"):
		n = countTabs(line)
		line = line.replace('<red>','<font color=red>').replace('</red>','</font>')
		line = line.replace('<green>','<font color=green>').replace('</green>','</font>')
		line = line.strip()
		arr = line.split("|")
		cmd = arr[0]

		if cmd in hash: line = hash[cmd](arr)

		if cmd == "" or cmd == 'A' or cmd == 'DOT':
			res.append(("\t"*n) + line)
		else:
			res.append(("\t"*n) + '<div class="I'+str(n)+'">' + line + '</div>')

	return '\n'.join(res)

start = time.time_ns()

transpileDir("Seniorschack_Stockholm")

print(round((time.time_ns() - start)/10**6),'ms')
